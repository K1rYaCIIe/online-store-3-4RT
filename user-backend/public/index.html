<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Интернет-магазин</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <h1>Наш магазин</h1>
        <div class="categories">
            <button class="category-btn active" data-category="all">Все товары</button>
            <button class="category-btn" data-category="Электроника">Электроника</button>
            <button class="category-btn" data-category="Книги">Книги</button>
        </div>
        <!-- Добавляем блок для выбора полей, которого не хватало -->
        <div class="fields-selector">
            <label><input type="checkbox" name="fields" value="name" checked> Название</label>
            <label><input type="checkbox" name="fields" value="price" checked> Цена</label>
            <label><input type="checkbox" name="fields" value="description"> Описание</label>
            <label><input type="checkbox" name="fields" value="categories"> Категории</label>
        </div>
    </header>
    
    <div class="products-container" id="products-container">
        <!-- Товары будут загружены через JavaScript -->
    </div>

    <div class="chat-container">
        <h2>Чат поддержки</h2>
        <div id="chat-messages"></div>
        <input type="text" id="chat-input" placeholder="Введите сообщение..." style="width: 70%; padding: 8px;">
        <button id="send-button" style="padding: 8px 15px;">Отправить</button>
    </div>



    <!-- style="height: 200px; overflow-y: scroll;background-color: rgb(250, 235, 215);border-radius: 10px; border: 1px solid #d06e6e; margin-bottom: 10px;" -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('products-container');
            const categoryBtns = document.querySelectorAll('.category-btn');
            
             // WebSocket клиент
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const ws = new WebSocket(`${wsProtocol}//${window.location.host}`);

            // Элементы интерфейса
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');
            const chatMessages = document.getElementById('chat-messages');

             // Обработчик открытия соединения
            ws.onopen = () => {
                console.log('Connected to WebSocket server');
            };

            // Обработчик входящих сообщений
            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                const messageElement = document.createElement('div');
                messageElement.innerHTML = `<strong>${message.sender}:</strong> ${message.text}`;
                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            };

            // Обработчик ошибок
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            // Обработчик закрытия соединения
            ws.onclose = () => {
                console.log('WebSocket connection closed');
            };

            // Отправка сообщения
            function sendMessage() {
                const text = chatInput.value.trim();
                if (text) {
                const message = {
                    sender: 'Покупатель', // Можно заменить на имя пользователя
                    text: text
                };
                ws.send(JSON.stringify(message));
                chatInput.value = '';
                }
            }

            // Обработчики событий
            sendButton.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                sendMessage();
                }
            });

            // Функция для получения выбранных полей
            function getSelectedFields() {
                const checkboxes = document.querySelectorAll('input[name="fields"]:checked');
                return Array.from(checkboxes).map(cb => cb.value).join(' ');
            }

            // Загрузка товаров
            async function loadProducts(category = 'all') {
                try {
                    const fields = getSelectedFields();
                    const query = category === 'all' 
                        ? `{ products { ${fields} } }`
                        : `{ productsByCategory(category: "${category}") { ${fields} } }`;

                    const response = await fetch('/graphql', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query })
                    });
                    
                    // Добавляем проверку на ошибки ответа
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const { data, errors } = await response.json();
                    
                    // Проверяем на ошибки GraphQL
                    if (errors) {
                        throw new Error(errors.map(e => e.message).join('\n'));
                    }
                    
                    const products = category === 'all' ? data.products : data.productsByCategory;
                    
                    if (!products || products.length === 0) {
                        container.innerHTML = '<div class="empty">Товары не найдены</div>';
                        return;
                    }
                    
                    // Динамическое создание карточек товаров на основе выбранных полей
                    container.innerHTML = products.map(product => {
                        let html = '<div class="product-card">';
                        if (product.name) html += `<h2>${product.name}</h2>`;
                        if (product.price) html += `<div class="price">${product.price} руб.</div>`;
                        if (product.description) html += `<p>${product.description}</p>`;
                        if (product.categories) html += `<div class="categories">Категории: ${product.categories.join(', ')}</div>`;
                        html += '</div>';
                        return html;
                    }).join('');
                } catch (error) {
                    console.error('Error:', error);
                    container.innerHTML = `<div class="error">Ошибка загрузки товаров: ${error.message}</div>`;
                }
            }
            
            // Обработчики для кнопок категорий
            categoryBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    categoryBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    loadProducts(btn.dataset.category);
                });
            });

            // Обработчики для чекбоксов
            document.querySelectorAll('input[name="fields"]').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const activeCategory = document.querySelector('.category-btn.active').dataset.category;
                    loadProducts(activeCategory);
                });
            });

            // Первоначальная загрузка
            loadProducts();
        });
    </script>
</body>
</html>